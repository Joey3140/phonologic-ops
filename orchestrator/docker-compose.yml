version: '3.8'

services:
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: phonologic-orchestrator
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=production
      - DEBUG=false
      - HOST=0.0.0.0
      - PORT=8000
      - ALLOWED_ORIGINS=https://ops.phonologic.cloud,https://phonologic.cloud
      
      # LLM Configuration (Anthropic Claude)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DEFAULT_MODEL=claude-sonnet-4-20250514
      
      # Agno Studio (optional - for debugging)
      - AGNO_API_KEY=${AGNO_API_KEY:-}
      
      # ClickUp Integration
      - CLICKUP_API_TOKEN=${CLICKUP_API_TOKEN}
      - CLICKUP_WORKSPACE_ID=${CLICKUP_WORKSPACE_ID:-}
      - CLICKUP_DEFAULT_LIST_ID=${CLICKUP_DEFAULT_LIST_ID:-}
      
      # Google Drive/Workspace
      - GOOGLE_SERVICE_ACCOUNT_JSON=${GOOGLE_SERVICE_ACCOUNT_JSON:-}
      - GOOGLE_DRIVE_FOLDER_ID=${GOOGLE_DRIVE_FOLDER_ID:-}
      
      # SendGrid Email
      - SENDGRID_API_KEY=${SENDGRID_API_KEY:-}
      - SENDGRID_FROM_EMAIL=ops@phonologic.ca
      - SENDGRID_FROM_NAME=Phonologic Operations
      
      # Redis (Upstash)
      - UPSTASH_REDIS_REST_URL=${UPSTASH_REDIS_REST_URL:-}
      - UPSTASH_REDIS_REST_TOKEN=${UPSTASH_REDIS_REST_TOKEN:-}
      
      # Security
      - API_SECRET_KEY=${API_SECRET_KEY:-}
    
    volumes:
      - orchestrator-data:/app/data
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - phonologic-network
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.orchestrator.rule=Host(`ops.phonologic.cloud`) && PathPrefix(`/api/orchestrator`)"
      - "traefik.http.routers.orchestrator.tls=true"
      - "traefik.http.routers.orchestrator.tls.certresolver=letsencrypt"
      - "traefik.http.services.orchestrator.loadbalancer.server.port=8000"

  # Optional: Traefik reverse proxy
  # Uncomment if you want to use Traefik for routing
  # traefik:
  #   image: traefik:v2.10
  #   container_name: traefik
  #   restart: unless-stopped
  #   command:
  #     - "--api.insecure=true"
  #     - "--providers.docker=true"
  #     - "--providers.docker.exposedbydefault=false"
  #     - "--entrypoints.web.address=:80"
  #     - "--entrypoints.websecure.address=:443"
  #     - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
  #     - "--certificatesresolvers.letsencrypt.acme.email=joey@phonologic.ca"
  #     - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #     - traefik-certs:/letsencrypt
  #   networks:
  #     - phonologic-network

volumes:
  orchestrator-data:
  # traefik-certs:

networks:
  phonologic-network:
    driver: bridge
